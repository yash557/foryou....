<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÄ Bestie Archives üéÄ</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Dancing+Script:wght@700&family=Courier+Prime&display=swap"
        rel="stylesheet">

    <script src="data.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Quicksand', sans-serif;
            color: #4a4a4a;
            background: linear-gradient(to bottom, #fad0c4 0%, #ffd1ff 100%);
        }

        /* --- BACKGROUND PHOTOS --- */
        #bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            pointer-events: none;
            overflow: hidden;
        }

        .polaroid {
            position: absolute;
            background: white;
            padding: 10px 10px 30px 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: rotate(var(--r));
            animation: floatUp var(--speed) linear infinite;
            top: 100vh;
            left: var(--left);
            opacity: 0.8;
            width: 140px;
        }

        .polaroid img {
            width: 100%;
            height: auto;
            display: block;
            filter: sepia(20%);
        }

        @keyframes floatUp {
            to {
                top: -300px;
            }
        }

        /* --- FALLING HEARTS (Main Menu) --- */
        #heart-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
        }

        .heart-bg {
            position: absolute;
            top: -10vh;
            color: #ff9a9e;
            font-size: var(--size);
            left: var(--left);
            opacity: var(--opacity);
            animation: fall var(--speed) linear infinite;
        }

        @keyframes fall {
            to {
                top: 110vh;
                transform: rotate(360deg);
            }
        }

        /* --- LOADING SCREEN --- */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier Prime', monospace;
            color: #0f0;
            padding: 20px;
            box-sizing: border-box;
        }

        .terminal-text {
            font-size: 1.2rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* --- UI CARDS --- */
        #ui-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 850px;
            text-align: center;
            z-index: 10;
            max-height: 95vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(157, 53, 98, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.5s ease;
        }

        .hidden {
            display: none !important;
        }

        /* --- MUSIC SLIDER STYLES --- */
        .carousel-wrapper {
            position: relative;
            width: 100%;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
            margin: 10px 0;
        }

        .music-card {
            position: absolute;
            width: 200px;
            height: 280px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            border: 2px solid white;
            opacity: 0.6;
            transform: translateX(0) scale(0.8);
            z-index: 1;
            filter: blur(2px);
        }

        .album-art {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: spin 4s linear infinite;
            animation-play-state: paused;
            background: #eee;
        }

        .art-1 {
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
        }

        .art-2 {
            background: linear-gradient(45deg, #a18cd1, #fbc2eb);
        }

        .art-3 {
            background: linear-gradient(45deg, #84fab0, #8fd3f4);
        }

        .art-4 {
            background: linear-gradient(45deg, #fccb90, #d57eeb);
        }

        .art-5 {
            background: linear-gradient(45deg, #e0c3fc, #8ec5fc);
        }

        .song-info h3 {
            margin: 10px 0 5px 0;
            color: #d63384;
            font-size: 1.1rem;
        }

        .song-info span {
            font-size: 0.8rem;
            color: #666;
            font-weight: bold;
        }

        .music-card.active {
            opacity: 1;
            transform: translateX(0) scale(1.1);
            z-index: 10;
            filter: blur(0);
            border: 4px solid #d63384;
            box-shadow: 0 20px 50px rgba(214, 51, 132, 0.4);
        }

        .music-card.active .album-art {
            animation-play-state: running;
        }

        .music-card.prev {
            transform: translateX(-180px) scale(0.8) rotateY(25deg);
        }

        .music-card.next {
            transform: translateX(180px) scale(0.8) rotateY(-25deg);
        }

        .music-card.far-prev {
            transform: translateX(-350px) scale(0.6);
            opacity: 0;
        }

        .music-card.far-next {
            transform: translateX(350px) scale(0.6);
            opacity: 0;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-top: 5px;
            z-index: 20;
            justify-content: center;
        }

        .nav-btn {
            background: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.2rem;
            color: #d63384;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: 0.2s;
        }

        .nav-btn:hover {
            transform: scale(1.1);
            background: #fff0f5;
        }

        .visualizer {
            display: flex;
            gap: 3px;
            height: 20px;
            align-items: flex-end;
            justify-content: center;
            margin-top: 5px;
            opacity: 0;
            transition: 0.3s;
        }

        .music-card.active .visualizer {
            opacity: 1;
        }

        .bar {
            width: 4px;
            background: #d63384;
            animation: bounce 0.5s infinite ease-in-out;
            border-radius: 2px;
        }

        .bar:nth-child(1) {
            height: 10px;
            animation-delay: 0.1s;
        }

        .bar:nth-child(2) {
            height: 15px;
            animation-delay: 0.2s;
        }

        .bar:nth-child(3) {
            height: 20px;
            animation-delay: 0.3s;
        }

        .bar:nth-child(4) {
            height: 12px;
            animation-delay: 0.1s;
        }

        .bar:nth-child(5) {
            height: 18px;
            animation-delay: 0.4s;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scaleY(0.5);
            }

            50% {
                transform: scaleY(1);
            }
        }

        /* --- CAKE & LETTER STYLES --- */
        #cake-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #cake-injection-site {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .cake-container {
            position: relative;
            width: 250px;
            height: 200px;
            margin-top: 50px;
        }

        .plate {
            width: 270px;
            height: 10px;
            background: #fff;
            position: absolute;
            bottom: -10px;
            left: -10px;
            border-radius: 10px;
            opacity: 0;
        }

        .layer {
            position: absolute;
            width: 100%;
            background: #f8a5c2;
            border-radius: 10px 10px 0 0;
            opacity: 0;
        }

        .layer-bottom {
            height: 100px;
            bottom: 0;
            background: #f78fb3;
        }

        .layer-middle {
            height: 30px;
            bottom: 60px;
            background: #fff0f5;
            z-index: 2;
        }

        .layer-top {
            width: 200px;
            height: 90px;
            bottom: 100px;
            left: 25px;
            background: #f8a5c2;
            z-index: 1;
        }

        .icing {
            position: absolute;
            width: 100%;
            height: 20px;
            background: #fff;
            border-radius: 20px;
            top: 0;
            z-index: 2;
        }

        .drip {
            width: 20px;
            height: 30px;
            background: #fff;
            position: absolute;
            top: 10px;
            border-radius: 0 0 20px 20px;
        }

        .d1 {
            left: 20px;
            height: 35px;
        }

        .d2 {
            left: 50px;
            height: 25px;
        }

        .d3 {
            left: 90px;
            height: 40px;
        }

        .d4 {
            right: 40px;
            height: 25px;
        }

        .candle {
            position: absolute;
            width: 10px;
            height: 40px;
            background: repeating-linear-gradient(45deg, #fff, #fff 5px, #74b9ff 5px, #74b9ff 10px);
            bottom: 190px;
            z-index: 5;
            opacity: 0;
        }

        .c1 {
            left: 60px;
        }

        .c2 {
            left: 120px;
            bottom: 200px;
            z-index: 6;
        }

        .c3 {
            right: 60px;
        }

        .flame {
            position: absolute;
            width: 12px;
            height: 20px;
            background: radial-gradient(ellipse at bottom, #ffeb3b, #ff9800);
            border-radius: 50% 50% 20% 20%;
            top: -25px;
            left: -1px;
            cursor: pointer;
            animation: flicker 1s infinite alternate;
        }

        .flame:hover {
            transform: scale(1.2);
        }

        .puff {
            animation: puff-out 0.5s forwards;
            background: #ddd !important;
            /* Smoke color */
        }

        .anim-plate {
            animation: dropIn 0.8s ease-out forwards;
        }

        .anim-bottom {
            animation: dropIn 0.8s ease-out forwards 0.6s;
        }

        .anim-middle {
            animation: dropIn 0.8s ease-out forwards 0.6s;
        }

        .anim-top {
            animation: dropIn 0.8s ease-out forwards 1.2s;
        }

        .anim-c1 {
            animation: dropIn 0.8s ease-out forwards 1.8s;
        }

        .anim-c2 {
            animation: dropIn 0.8s ease-out forwards 2.0s;
        }

        .anim-c3 {
            animation: dropIn 0.8s ease-out forwards 2.2s;
        }

        @keyframes dropIn {
            0% {
                transform: translateY(-500px);
                opacity: 0;
            }

            60% {
                transform: translateY(20px);
                opacity: 1;
            }

            80% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes flicker {
            0% {
                transform: scale(1) rotate(-2deg);
                opacity: 0.9;
            }

            100% {
                transform: scale(1.1) rotate(2deg);
                opacity: 1;
            }
        }

        @keyframes puff-out {
            0% {
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* --- TREE OVERLAY (NIGHT MODE) --- */
        #tree-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #020111 0%, #20202c 100%);
            /* Night Sky */
            z-index: 400;
            /* Highest priority */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #scene-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 1.5s ease-in-out;
        }

        /* Tree Canvases */
        #sky-canvas,
        #tree-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #sky-canvas {
            z-index: 1;
        }

        #tree-canvas {
            z-index: 2;
            filter: drop-shadow(0 0 15px rgba(255, 105, 180, 0.4));
        }

        /* Tree Letter Card */
        #letter-card {
            position: absolute;
            right: 10%;
            width: 40%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.2);
            font-family: 'Dancing Script', cursive;
            font-size: 1.5rem;
            color: #ffb7b2;
            text-shadow: 0 0 5px rgba(255, 183, 178, 0.5);
            line-height: 1.5;
            opacity: 0;
            transform: translateX(50px);
            transition: all 1s ease-out;
            z-index: 10;

            /* SCROLL FIXES */
            max-height: 75vh;
            /* Limits height so it fits on screen */
            overflow-y: auto;
            /* Adds scrollbar if text is too long */
            scrollbar-width: thin;
            /* For Firefox */
            scrollbar-color: rgba(255, 183, 178, 0.5) transparent;
        }

        /* Custom Scrollbar for Chrome/Safari/Edge */
        #letter-card::-webkit-scrollbar {
            width: 6px;
        }

        #letter-card::-webkit-scrollbar-track {
            background: transparent;
        }

        #letter-card::-webkit-scrollbar-thumb {
            background-color: rgba(255, 183, 178, 0.5);
            border-radius: 10px;
        }

        .slide-left #tree-canvas {
            transform: translateX(-30%);
            transition: transform 1.5s ease-in-out;
        }

        .show-letter #letter-card {
            opacity: 1;
            transform: translateX(0);
        }

        .btn-close-letter {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            padding: 10px 20px;
            float: right;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
            font-family: 'Quicksand', sans-serif;
        }

        .btn-close-letter:hover {
            background: white;
            color: #000;
        }

        /* --- WISH FORM STYLES --- */
        #wish-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 500;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .wish-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 2px solid #fff;
        }

        .wish-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ff9a9e;
            border-radius: 12px;
            font-family: 'Quicksand', sans-serif;
            font-size: 1rem;
            outline: none;
            box-sizing: border-box;
            background: #fff0f5;
        }

        .wish-input:focus {
            border-color: #d63384;
            background: #fff;
        }

        textarea.wish-input {
            height: 100px;
            resize: none;
        }

        /* --- NEW BUTTON STYLES --- */
        .btn-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-whatsapp {
            background: #25D366;
            flex: 1;
            font-size: 0.9rem;
            padding: 12px;
        }

        .btn-insta {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            flex: 1;
            font-size: 0.9rem;
            padding: 12px;
        }

        /* --- UI ELEMENTS --- */
        h1 {
            color: #d63384;
            margin-top: 0;
            font-size: 2rem;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            margin: 10px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            color: white;
            box-shadow: 0 4px 10px rgba(214, 51, 132, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        .btn-p1 {
            background: linear-gradient(to right, #c471ed, #f64f59);
        }

        .btn-p2 {
            background: linear-gradient(to right, #ff758c, #ff7eb3);
        }

        .btn-menu {
            background: linear-gradient(45deg, #11998e, #38ef7d);
            width: 80%;
            padding: 20px;
            font-size: 1.3rem;
            margin: 15px 0;
        }

        #music-player-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #d63384;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .particle {
            position: absolute;
            pointer-events: none;
            animation: pop 0.8s ease-out forwards;
            font-size: 1.5rem;
        }

        @keyframes pop {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <!-- LOADING SCREEN -->
    <div id="loading-screen">
        <div class="terminal-text" id="terminal-text"></div>
    </div>

    <!-- BACKGROUND LAYERS (Menu) -->
    <div id="bg-container"></div>
    <div id="heart-container"></div>

    <!-- AUDIO -->
    <audio id="bg-audio" loop></audio>
    <div id="music-player-controls" class="hidden">
        <span id="now-playing-label">üéµ</span>
        <button onclick="toggleAudio()"
            style="background:none; border:none; cursor:pointer; font-size:1.2rem;">‚èØÔ∏è</button>
        <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="adjustVolume(this)" style="width: 60px;">
    </div>

    <!-- CAKE OVERLAY (Dynamic Injection Site) -->
    <div id="cake-modal" class="hidden">
        <div id="cake-injection-site">
            <!-- CAKE WILL BE BUILT HERE BY JS -->
        </div>
    </div>

    <!-- WISH FORM OVERLAY -->
    <div id="wish-overlay" class="hidden">
        <div class="wish-card">
            <h2 style="color: #d63384; margin-bottom: 10px;">‚ú® Make a Wish ‚ú®</h2>
            <p style="color: #666; font-size: 0.9rem;">Fill this in, then send it to me!</p>

            <input type="text" id="wish-input" class="wish-input" placeholder="My Birthday Wish is...">
            <textarea id="message-input" class="wish-input" placeholder="Anything else you want to say?"></textarea>

            <div class="btn-group">
                <button class="btn btn-whatsapp" onclick="sendWhatsApp()">WhatsApp üíö</button>
                <button class="btn btn-insta" onclick="sendInstagram()">Instagram üì∏</button>
            </div>
        </div>
    </div>

    <!-- TREE & LETTER OVERLAY (Night Mode) -->
    <div id="tree-overlay" class="hidden">
        <div id="scene-container">
            <canvas id="sky-canvas"></canvas>
            <canvas id="tree-canvas"></canvas>
            <div id="letter-card">
                <h2 style="margin-top:0; color: #fff;">To My Pookieee,</h2>
                <div id="letter-content-tree"></div> <!-- Content injected here -->
                <br>
                <!-- NEW: This button opens the wish form -->
                <button class="btn-close-letter" onclick="showWishForm()">Make a Wish ‚ú®</button>
            </div>
        </div>
    </div>

    <div id="ui-container" class="hidden">

        <!-- SCREEN 1: MUSIC SELECTION (CAROUSEL) -->
        <div class="glass-card" id="music-screen">
            <h1>üéß Choose the Vibe</h1>
            <p style="color:#666; font-size:0.9rem;">Slide to preview & pick a track</p>

            <div class="carousel-wrapper">
                <!-- JS Injects Cards Here -->
            </div>

            <div class="controls">
                <button class="nav-btn" onclick="moveCarousel(-1)">‚ùÆ</button>
                <button class="nav-btn" onclick="moveCarousel(1)">‚ùØ</button>
            </div>

            <button class="btn btn-p1" onclick="confirmMusicSelection()" style="margin-top:20px;">This is the one!
                ‚ú®</button>
        </div>

        <!-- SCREEN 2: MENU -->
        <div class="glass-card hidden" id="menu-screen">
            <h1>üéÇ Birthday Arcade üéÇ</h1>
            <button class="btn btn-menu" onclick="launchTrivia()">üí¨ Chat Trivia</button>
            <br><br>
            <p style="font-size:0.9rem; color:#888;">Ready to celebrate?</p>
            <button class="btn btn-p2" id="btn-open-cake" onclick="startCakeCeremony()">üíå Open Birthday Card</button>
        </div>

        <!-- TRIVIA -->
        <div class="glass-card hidden" id="trivia-screen">
            <div
                style="font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; color: #d63384; font-weight: bold;">
                Who sent this?</div>
            <div id="question-text"
                style="font-size: 1.3rem; font-weight: 700; color: #2d3436; margin: 25px 0; min-height: 80px; display: flex; align-items: center; justify-content: center; font-style: italic;">
                Loading...</div>
            <div id="options-area"></div>
            <div id="result-area" class="hidden">
                <h2 id="result-title"></h2>
                <div id="reveal-text"></div>
                <div id="time-reveal" style="color: #888; font-size: 0.9rem;"></div>
                <button class="btn btn-p1" style="margin-top:15px;" onclick="nextQuestion()">Next ‚û°Ô∏è</button>
            </div>
            <div style="margin-top:20px;">Score: <span id="score">0</span> <button onclick="showMenu()"
                    style="float:right; border:none; background:none; cursor:pointer;">Back</button></div>
        </div>

    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // === UPDATE THIS! ===
        const MY_PHONE_NUMBER = "919150095526";
        const MY_INSTAGRAM_USERNAME = "_arafaxz_";

        const LOADING_TEXTS = [
            "> Initializing Friendship Protocol...",
            "> Loading inside jokes database...",
            "> Retrieving embarrassing photos...",
            "> Decrypting secrets...",
            "> ACCESS GRANTED. HAPPY BIRTHDAY!"
        ];

        const MY_LETTER = `Happy Kuva Kuva day!!<br><br> vanakam da maplai, You know, when I think about us and everything we‚Äôve been through, it honestly feels like a long-running series ‚Äî full of drama, comedy, unexpected plot twists, and two characters who somehow never get tired of each other. Our bond has survived everything But lately‚Ä¶ something feels a little different. 
        Not bad, just‚Ä¶ distant. Like we‚Äôre still in the same story, but the scenes aren‚Äôt as close as they used to be. And maybe it‚Äôs life being life, or maybe we‚Äôre just growing in different directions for a moment. Still, it‚Äôs a weird feeling, because I treasure what we have ‚Äî the laughter, the chaos, the comfort, the spark.<br><br>If you want to say something you can reply in thisüòâ!`;

        const SONGS = [
            { title: "Chill Vibes", artist: "Memories", file: "song1.mp3", emoji: "üåä" },
            { title: "Chaos Energy", artist: "Inside Jokes", file: "song2.mp3", emoji: "‚ö°" },
            { title: "Nostalgia", artist: "2019 Era", file: "song3.mp3", emoji: "üìº" },
            { title: "Roadtrip", artist: "Sing-along", file: "song4.mp3", emoji: "üöó" },
            { title: "Birthday Bop", artist: "Celebration", file: "song5.mp3", emoji: "üéÇ" }
        ];

        // --- 2. GLOBAL VARIABLES ---
        const audioPlayer = document.getElementById('bg-audio');
        let allMessages = []; let senders = new Set(); let score = 0; let currentMessage = null;
        let musicIndex = 0;

        // --- 3. INITIALIZATION ---
        window.onload = function () {
            if (typeof MY_CHAT_DATA !== 'undefined') {
                allMessages = MY_CHAT_DATA;
                allMessages.forEach(msg => senders.add(msg.sender_name));
            }
            // Put letter content in the tree overlay
            document.getElementById('letter-content-tree').innerHTML = MY_LETTER;

            // Start Hacker Text
            typeLine();
        };

        // --- 4. MUSIC LOGIC ---
        function initCarousel() {
            const wrapper = document.querySelector('.carousel-wrapper');
            wrapper.innerHTML = '';
            SONGS.forEach((song, index) => {
                const card = document.createElement('div');
                card.className = `music-card art-${index + 1}`;
                card.innerHTML = `
                    <div class="album-art">${song.emoji}</div>
                    <div class="song-info"><h3>${song.title}</h3><span>${song.artist}</span></div>
                    <div class="visualizer"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                `;
                wrapper.appendChild(card);
            });
            updateClasses();
            playCurrentSong();
        }

        function updateClasses() {
            const cards = document.querySelectorAll('.music-card');
            cards.forEach((card, i) => {
                card.className = `music-card art-${i + 1}`;
                if (i === musicIndex) card.classList.add('active');
                else if (i === musicIndex - 1) card.classList.add('prev');
                else if (i === musicIndex + 1) card.classList.add('next');
                else if (i < musicIndex) card.classList.add('far-prev');
                else card.classList.add('far-next');
            });
        }

        function moveCarousel(dir) {
            const newIndex = musicIndex + dir;
            if (newIndex < 0 || newIndex >= SONGS.length) return;
            musicIndex = newIndex;
            updateClasses();
            playCurrentSong();
        }

        function playCurrentSong() {
            const song = SONGS[musicIndex];
            audioPlayer.src = song.file;
            audioPlayer.volume = 0.5;
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) { playPromise.catch(error => console.log("Auto-play prevented")); }
            document.getElementById('now-playing-label').textContent = "üéµ " + song.title;
        }

        function confirmMusicSelection() {
            document.getElementById('music-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
            document.getElementById('music-player-controls').classList.remove('hidden');
        }

        function toggleAudio() { if (audioPlayer.paused) audioPlayer.play(); else audioPlayer.pause(); }
        function adjustVolume(s) { audioPlayer.volume = s.value; }
        function showMenu() {
            document.querySelectorAll('.glass-card').forEach(el => el.classList.add('hidden'));
            document.getElementById('menu-screen').classList.remove('hidden');
        }

        // --- 5. BACKGROUND EFFECTS (Main) ---
        const bgContainer = document.getElementById('bg-container');
        for (let i = 0; i < 12; i++) {
            let div = document.createElement('div'); div.className = 'polaroid';
            let img = document.createElement('img'); img.src = `bg${(i % 8) + 1}.jpg`;
            div.appendChild(img);
            div.style.setProperty('--left', Math.random() * 90 + '%');
            div.style.setProperty('--r', (Math.random() - 0.5) * 30 + 'deg');
            div.style.setProperty('--speed', (15 + Math.random() * 25) + 's');
            div.style.animationDelay = (Math.random() * -20) + 's';
            bgContainer.appendChild(div);
        }
        const heartContainer = document.getElementById('heart-container');
        for (let i = 0; i < 25; i++) {
            let h = document.createElement('div'); h.className = 'heart-bg';
            h.textContent = ['‚ù§Ô∏è', 'üíñ', 'üéÄ', 'üå∏'][Math.floor(Math.random() * 4)];
            h.style.setProperty('--left', Math.random() * 100 + '%');
            h.style.setProperty('--size', (1 + Math.random() * 2) + 'rem');
            h.style.setProperty('--opacity', 0.3 + Math.random() * 0.5);
            h.style.setProperty('--speed', (5 + Math.random() * 10) + 's');
            h.style.animationDelay = (Math.random() * -10) + 's';
            heartContainer.appendChild(h);
        }

        // --- 6. HACKER LOADING ---
        let lineIndex = 0;
        function typeLine() {
            if (lineIndex < LOADING_TEXTS.length) {
                const p = document.createElement('div'); p.textContent = LOADING_TEXTS[lineIndex];
                document.getElementById('terminal-text').appendChild(p);
                lineIndex++; setTimeout(typeLine, 800);
            } else {
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('ui-container').classList.remove('hidden');
                    initCarousel();
                }, 1500);
            }
        }

        // --- 7. CAKE CEREMONY ---
        let candlesBlown = 0;

        const CAKE_HTML_TEMPLATE = `
            <h2 style="color:white; margin-bottom:30px;">Make a wish & click the flames! üéÇ</h2>
            <div class="cake-container">
                <div class="plate" id="cake-plate"></div>
                <div class="layer layer-bottom" id="cake-bottom"></div>
                <div class="layer layer-middle" id="cake-middle"></div>
                <div class="layer layer-top" id="cake-top">
                    <div class="icing"><div class="drip d1"></div><div class="drip d2"></div><div class="drip d3"></div><div class="drip d4"></div></div>
                </div>
                <div class="candle c1" id="cake-c1"><div class="flame" onclick="blowCandle(this)"></div></div>
                <div class="candle c2" id="cake-c2"><div class="flame" onclick="blowCandle(this)"></div></div>
                <div class="candle c3" id="cake-c3"><div class="flame" onclick="blowCandle(this)"></div></div>
            </div>
        `;

        function startCakeCeremony() {
            candlesBlown = 0;
            const injectionSite = document.getElementById('cake-injection-site');
            injectionSite.innerHTML = CAKE_HTML_TEMPLATE;
            document.getElementById('cake-modal').classList.remove('hidden');
            setTimeout(() => {
                const ids = ['cake-plate', 'cake-bottom', 'cake-middle', 'cake-top', 'cake-c1', 'cake-c2', 'cake-c3'];
                const classes = ['anim-plate', 'anim-bottom', 'anim-middle', 'anim-top', 'anim-c1', 'anim-c2', 'anim-c3'];
                ids.forEach((id, i) => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add(classes[i]);
                });
            }, 50);
        }

        window.blowCandle = function (element) {
            if (element.classList.contains('puff')) return;
            element.classList.remove('flame');
            element.classList.add('puff');
            candlesBlown++;
            if (candlesBlown === 3) {
                setTimeout(() => {
                    document.getElementById('cake-modal').classList.add('hidden');
                    // OLD: document.getElementById('wish-overlay').classList.remove('hidden');
                    // NEW: START TREE ANIMATION
                    startTreeSequence();
                }, 1000);
            }
        }

        // --- NEW: SEND WISH LOGIC ---
        function getWishText() {
            const wish = document.getElementById('wish-input').value;
            const msg = document.getElementById('message-input').value;
            return `Hey! üéÇ I just made a wish on the birthday app: "${wish}". Also, ${msg}`;
        }

        function sendWhatsApp() {
            const finalMsg = getWishText();
            const url = `https://wa.me/${MY_PHONE_NUMBER}?text=${encodeURIComponent(finalMsg)}`;
            window.open(url, '_blank');
            closeWishForm();
        }

        function sendInstagram() {
            const finalMsg = getWishText();
            navigator.clipboard.writeText(finalMsg).then(() => {
                alert("Message copied to clipboard! Paste it in the chat üéÄ");
                const url = `https://ig.me/m/${MY_INSTAGRAM_USERNAME}`;
                window.open(url, '_blank');
                closeWishForm();
            });
        }

        function showWishForm() {
            // Hide Tree & Reset
            document.getElementById('tree-overlay').classList.add('hidden');
            document.getElementById('scene-container').classList.remove('slide-left', 'show-letter');
            // Show Wish
            document.getElementById('wish-overlay').classList.remove('hidden');
        }

        function closeWishForm() {
            document.getElementById('wish-overlay').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
        }

        // --- TREE ANIMATION & LETTER REVEAL ---
        const treeCanvas = document.getElementById('tree-canvas');
        const skyCanvas = document.getElementById('sky-canvas');
        const ctx = treeCanvas.getContext('2d');
        const skyCtx = skyCanvas.getContext('2d');
        let width, height, startX, startY;
        let stars = [], meteors = [];
        let activeBranches = [];
        let treeAnimationId = null;

        function resizeTree() {
            width = treeCanvas.width = skyCanvas.width = window.innerWidth;
            height = treeCanvas.height = skyCanvas.height = window.innerHeight;
            startX = width / 2; startY = height;
        }
        window.addEventListener('resize', resizeTree);

        function startTreeSequence() {
            // Ensure other overlays are gone
            document.getElementById('wish-overlay').classList.add('hidden');
            // Show Tree Overlay
            document.getElementById('tree-overlay').classList.remove('hidden');

            // Setup Canvas
            resizeTree();
            initSky();
            ctx.clearRect(0, 0, width, height);

            // Draw Roots (Simple static draw for roots is fine)
            drawRoots(startX, startY);

            // Initialize Growth System
            activeBranches = [];
            // Start Trunk
            activeBranches.push({
                x: startX, y: startY, angle: -Math.PI / 2, length: 150, width: 20,
                currentLength: 0, depth: 0, maxDepth: 12
            });

            if (treeAnimationId) cancelAnimationFrame(treeAnimationId);
            animateTree();
        }

        function initSky() {
            stars = [];
            for (let i = 0; i < 150; i++) {
                stars.push({
                    x: Math.random() * width, y: Math.random() * height,
                    size: Math.random() * 2, speed: Math.random() * 0.5 + 0.1, opacity: Math.random()
                });
            }
            animateSky();
        }

        function drawMoon() {
            const mx = width * 0.85; const my = height * 0.15; const r = 50;
            const gradient = skyCtx.createRadialGradient(mx, my, r * 0.8, mx, my, r * 4);
            gradient.addColorStop(0, "rgba(255, 255, 255, 0.8)");
            gradient.addColorStop(0.1, "rgba(255, 255, 240, 0.5)");
            gradient.addColorStop(0.4, "rgba(255, 255, 255, 0.1)");
            gradient.addColorStop(1, "rgba(255, 255, 255, 0)");
            skyCtx.fillStyle = gradient; skyCtx.beginPath(); skyCtx.arc(mx, my, r * 4, 0, Math.PI * 2); skyCtx.fill();
            skyCtx.fillStyle = "#fffce6"; skyCtx.shadowColor = "#fffce6"; skyCtx.shadowBlur = 20;
            skyCtx.beginPath(); skyCtx.arc(mx, my, r, 0, Math.PI * 2); skyCtx.fill(); skyCtx.shadowBlur = 0;
        }

        function animateSky() {
            if (document.getElementById('tree-overlay').classList.contains('hidden')) return;
            skyCtx.clearRect(0, 0, width, height);
            skyCtx.fillStyle = "white";
            stars.forEach(star => {
                skyCtx.globalAlpha = star.opacity; skyCtx.beginPath(); skyCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2); skyCtx.fill();
                star.y += star.speed; if (star.y > height) { star.y = 0; star.x = Math.random() * width; }
            });
            if (Math.random() < 0.01) { meteors.push({ x: Math.random() * width, y: 0, speedX: (Math.random() - 0.5) * 10, speedY: Math.random() * 10 + 5, life: 1 }); }
            meteors.forEach((m, i) => {
                skyCtx.globalAlpha = m.life; skyCtx.strokeStyle = "rgba(255, 255, 255, 1)"; skyCtx.lineWidth = 2;
                skyCtx.beginPath(); skyCtx.moveTo(m.x, m.y); skyCtx.lineTo(m.x - m.speedX * 3, m.y - m.speedY * 3); skyCtx.stroke();
                m.x += m.speedX; m.y += m.speedY; m.life -= 0.02; if (m.life <= 0) meteors.splice(i, 1);
            });
            skyCtx.globalAlpha = 1; drawMoon();
            requestAnimationFrame(animateSky);
        }

        function drawRoots(x, y) {
            ctx.strokeStyle = '#2d1a12'; ctx.lineWidth = 4;
            for (let i = 0; i < 16; i++) {
                ctx.beginPath(); ctx.moveTo(x, y);
                const len = Math.random() * 50 + 20; const ang = Math.PI / 2 + (Math.random() - 0.5) * 2.5;
                ctx.lineTo(x + len * Math.cos(ang), y + len * Math.sin(ang)); ctx.stroke();
            }
        }

        // --- NEW ITERATIVE TREE ANIMATION LOOP ---
        function animateTree() {
            if (activeBranches.length === 0) {
                // Done growing
                if (!document.getElementById('scene-container').classList.contains('slide-left')) {
                    setTimeout(triggerSlide, 500);
                }
                return;
            }

            for (let i = activeBranches.length - 1; i >= 0; i--) {
                let branch = activeBranches[i];
                let growthRate = 8; // Speed
                let prevX = branch.x + Math.cos(branch.angle) * branch.currentLength;
                let prevY = branch.y + Math.sin(branch.angle) * branch.currentLength;

                branch.currentLength += growthRate;
                if (branch.currentLength > branch.length) branch.currentLength = branch.length;

                let currentX = branch.x + Math.cos(branch.angle) * branch.currentLength;
                let currentY = branch.y + Math.sin(branch.angle) * branch.currentLength;

                ctx.beginPath(); ctx.moveTo(prevX, prevY); ctx.lineTo(currentX, currentY);
                ctx.lineWidth = branch.width;
                let colorVal = 20 + (16 - branch.width) * 5; ctx.strokeStyle = `hsl(25, 40%, ${colorVal}%)`;
                ctx.lineCap = 'round'; ctx.stroke();

                if (branch.currentLength >= branch.length) {
                    activeBranches.splice(i, 1);
                    if (branch.depth < branch.maxDepth) {
                        let numChildren = Math.random() > 0.3 ? 3 : 2;
                        for (let j = 0; j < numChildren; j++) {
                            let angleOffset = (Math.random() - 0.5) * 1.5;
                            let newLength = branch.length * 0.75;
                            let newWidth = branch.width * 0.7;
                            if (newWidth < 1) newWidth = 1;
                            activeBranches.push({
                                x: currentX, y: currentY, angle: branch.angle + angleOffset,
                                length: newLength, width: newWidth, currentLength: 0,
                                depth: branch.depth + 1, maxDepth: branch.maxDepth
                            });
                        }
                    } else {
                        drawHeartsInstant(currentX, currentY);
                    }
                }
            }
            treeAnimationId = requestAnimationFrame(animateTree);
        }

        function drawHeartsInstant(x, y) {
            for (let i = 0; i < 5; i++) {
                const size = Math.random() * 10 + 5; const hx = x + (Math.random() - 0.5) * 40; const hy = y + (Math.random() - 0.5) * 40;
                const color = `hsl(${320 + Math.random() * 40}, 100%, ${60 + Math.random() * 20}%)`;
                ctx.save(); ctx.translate(hx, hy); ctx.rotate(Math.random() * Math.PI); ctx.fillStyle = color; ctx.shadowColor = color; ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.moveTo(0, size * 0.3);
                ctx.bezierCurveTo(0, 0, -size / 2, 0, -size / 2, size * 0.3);
                ctx.bezierCurveTo(-size / 2, (size + size * 0.3) / 2, 0, size, 0, size * 1.3);
                ctx.bezierCurveTo(0, size, size / 2, (size + size * 0.3) / 2, size / 2, size * 0.3);
                ctx.bezierCurveTo(size / 2, 0, 0, 0, 0, size * 0.3);
                ctx.fill(); ctx.restore();
            }
        }

        function triggerSlide() {
            const container = document.getElementById('scene-container');
            container.classList.add('slide-left');
            setTimeout(() => { container.classList.add('show-letter'); }, 1000);
        }

        // --- 8. GAME LOGIC (Trivia) ---
        function launchTrivia() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('trivia-screen').classList.remove('hidden');
            if (document.getElementById('options-area').children.length === 0) {
                const names = Array.from(senders);
                const optionsArea = document.getElementById('options-area');
                names.forEach((name, i) => {
                    const btn = document.createElement('button');
                    btn.className = i === 0 ? 'btn btn-p1' : 'btn btn-p2';
                    btn.textContent = name;
                    btn.onclick = (e) => checkTrivia(name, e.target);
                    optionsArea.appendChild(btn);
                });
            }
            nextQuestion();
        }
        function nextQuestion() {
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('options-area').classList.remove('hidden');
            currentMessage = allMessages[Math.floor(Math.random() * allMessages.length)];
            document.getElementById('question-text').textContent = `"${currentMessage.content}"`;
        }
        function checkTrivia(guess, btn) {
            const resultArea = document.getElementById('result-area');
            document.getElementById('options-area').classList.add('hidden');
            resultArea.classList.remove('hidden');
            const actual = currentMessage.sender_name;
            const title = document.getElementById('result-title');
            if (guess === actual) {
                title.innerHTML = "‚ú® CORRECT! ‚ú®"; title.style.color = "#2ecc71";
                score++; document.getElementById('score').textContent = score;
                createBurst(btn);
            } else {
                title.innerHTML = "ü•Ä WRONG! ü•Ä"; title.style.color = "#e74c3c";
            }
            document.getElementById('reveal-text').innerHTML = `It was <strong>${actual}</strong>`;
        }

        function createBurst(target) {
            const rect = target.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div'); p.textContent = ['üéÄ', '‚ú®', 'üíñ'][Math.floor(Math.random() * 3)];
                p.className = 'particle'; p.style.left = centerX + 'px'; p.style.top = centerY + 'px';
                p.style.setProperty('--tx', (Math.random() - 0.5) * 200 + 'px'); p.style.setProperty('--ty', (Math.random() - 0.5) * 200 + 'px');
                document.body.appendChild(p); setTimeout(() => p.remove(), 800);
            }
        }
    </script>
</body>

</html>
